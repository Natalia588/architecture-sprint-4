# Планирование: анализ, идентификация проблем и поиск решений

## Анализ системы

### Система состоит из 3-х приложений:

- Интернет магазин
  - Frontend - Shop UI 
    - используется клиентами для создания заказов
  - Backend - Shop API 
    - предоставляет информацию для Shop UI 
    - сохраняет 3D модели в общую базу S3 
    - сохраняет информацию о клиентских заказах в Shop DB (PostgreSQL)


- CRM система
  - Frontend - CRM UI 
    - используется отделом продаж для отслеживания заказов и их исполнения на производстве
  - Backend - CRM API 
    - предоставляет информацию для CRM UI на основе данных из S3 базы, Shop DB
    - обменивается информацией с MES через RabbitMQ 


- MES система
  - Frontend - MES UI 
    - используется операторами на производстве для взятия заказов в работу
  - Backend - MES API 
    - осуществляет расчет стоимости на основании 3D моделей, в среднем расчет занимает 2-3 минуты, но в случае сложной модеди - до 30 минут.
    - предоставляет информацию для MES UI, позволяя взять заказ в исполнение
    - предоставляет информацию внешним пользователям, позволяет им создать заказ
  - MES DB
    - Хранит информацию о заказах, их статусах, об исполнителях

### Также есть общие компоненты:

  - Shop DB (PostgreSQL) 
    - база данных для хранения информации о заказах клиентов, используется для обмена информацией между Shop API и CRM API
  - S3 DB
    - база данных для хранения 3D моделей, используется всеми 3-мя приложениями
  - Message Queue (RabbitMQ) 
    - для обмена информацией о клиентских заказах между CRM и MES. 
    - для создания заказов со стороны внешних клиентов


## Идентификация проблем

### Проблемы компании
При возрастающей линейной нагрузке (+100 дополнительных заказов каждый месяц) увеличивается срок исполнения заказов. 
Проблемы не на стороне производства: производственные мощности позволяют справиться с заказами и могут обеспечить двукратный рост.

Также компания дала доступ к MES API внешним пользователям для создания заказов. 
После этого проблемы стали еще ощутимее - жалоб от клиентов на просроченные заказы стало еще больше.

### Проблемные места системы
  - Узкое место системы - это MES API, очевидно, что этот компонент не справляется с ростом нагрузки, в нём собрано слишком много функционала
    - Расчет стоимости - очень трудоемкая операция, очевидно, что это блокирует работу всего приложения при большом количестве заказов.
    - Неоптимальная работа MES API по предоставлению информации о заказах операторам в MES UI - все очень долго прогружается.
    - Регистрация заказов от внешних пользователей происходит через очередь RabbitMQ. Есть вероятность, что сообщения о новых заказах теряются, так как
      представители компаний жалуются, что не получили своих заказов.

  - Shop API и CRM API обмениваются информацией через общую базу данных - это делает их зависимыми, кроме того общая база данных становится общей точкой отказа.

  - Не предусмотрены мониторинг, трассировка, логирование, кэширование.

  - Не предусмотрено горизонтальное масштабирование компонентов системы, без этого сложно адаптироваться к увеличению нагрузки.

  - Не предусмотрены варианты обработки отказов.


### Потенциальные проблемные места
  - Отсутствует репликация данных в базах (Shop DB, S3 DB, MES DB), что может привести к потере данных в случае сбоя.
  - Отсутствует репликация данных в Message Broker, что может привести к потере данных.
  - CRM и Shop связаны между собой общей базой данных, что делает их зависимыми друг от друга.


## Решения

### Приоритетные изменения

Для скорейшего решения проблем с заказами (в ближайшие полгода):

  1. Улучшение наблюдаемости - добавление в систему мониторинга, трассировки, логирования.
  2. Оптимизация кода, отвечающего за вычисление стоимости по 3D моделям. 
  3. Выделение функционала по расчету стоимости в отдельный сервис с возможностью масштабирования.
  4. Добавление клиентского уровня кэширования для MES UI
  5. Добавление серверного уровня кэширования в MES API
  6. Сохранение данных о внешних заказах в кэш и базу перед отправкой в Rabbit
  7. Добавление логики на обработку сбоев

Если можно взять только 3 задачи, то обязательно: 1, 2, 5.

### Долгосрочные изменения

  - Разделение базы Shop DB для снижения зависимостей между Shop и CRM
  - Обмен данными между Shop и CRM через Message Broker
  - Добавление логики на обработку сбоев
  - Отдельный сервис для обслуживания 3D моделей с REST API, которому будет принадлежать база данных S3
  - Настройка репликации для всех баз данных
  - Настройка репликации для Message Broker
  - Добавление клиентского и серверного кэширования во всех 3-х приложениях
  - Настройка горизонтального масштабирования всех сервисов в зависимости от нагрузки

