# Архитектурное решение по трейсингу

## Анализ

Трейсы должны отправлять все 3 приложения. 
Трейсинг начинается с точки входа запроса в приложение: 
он запускается для запроса и имеет уникальный идентификатор, 
сгенерированный для этого запроса. По мере того как трафик переходит 
от сервиса к сервису, каждый сервис добавляет информацию 
(например, время поступления запроса в сервис и время, 
затраченное на его обработку).

- Shop API
  - при вызове api
  - при чтении / записи информации о заказе в базу данных
  - при сохранении файла в S3 хранилище


- CRM API
  - при вызове api
  - при чтении / записи информации о заказе в базу данных
  - при чтении / записи событий о заказе в Message Broker


- MES API
  - при вызове api
  - при чтении файла из S3 хранилища
  - при вычислении стоимости заказа (начало/конец)
  - при чтении / записи информации о заказе в базу данных
  - при чтении / записи событий о заказе в Message Broker


## Мотивация

Трейсинг помогает быстро находить причины, например, медленной работы сервиса. 
Вместо просмотра всей цепочки вызовов, которую нужно к тому же раскрутить, 
разработчик может посмотреть, сколько, где и с какими параметрами прошёл вызов. 
У трейсинга как средства устранения неполадок есть дополнительные преимущества, 
поскольку любое исключение или ошибка обычно фиксируется вместе со всем контекстом запроса.

С внедрением трейсинга повысится наблюдаемость приложения - 
можно будет заранее проанализировать "маршруты и скорость" запросов к api, выявить узкие места
и начать работать над оптимизацией не дожидаясь эскалаций от клиентов.
Разработчики будут быстрее анализировать возникающие проблемы и предоставлять их решения.



## Предлагаемое решение

В Shop API, CRM API, MES API необходимо добавить OTel SDK для сбора телеметрии. 
Обернуть нужные вызовы для сбора данных.
Настроить Jaeger для визуализации данных телеметрии полученных с помощью OTel. 


```markdown
[diagram С4](./jewerly_c4_model.jpg)
```

## Компромиссы 

Добавление трейсинга в MES API на начальном этапе поможет отследить, где именно теряются заказы и возникают задержки.
Но это создаст дополнительные сложности при последующем разбиении MES API на микросервисы.



## Безопасность

Авторизация в Jaeger UI напрямую не предусмотрена.
Можно разместить Jaeger UI за обратным прокси, например nginx proxy, настроив авторизацию там.